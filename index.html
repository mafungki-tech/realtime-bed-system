<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>1A IV Cap</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #f9f9f9;
            padding: 20px;
        }
        h1 {
            margin-bottom: 20px;
        }
        #controls {
            margin-bottom: 20px;
        }
        .team {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fff;
        }
        #bed-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
        }
        .bed {
            cursor: pointer;
            padding: 20px;
            border-radius: 10px;
            background-color: #fff;
            border: 1px solid #ccc;
            transition: all 0.3s;
            font-size: 20px;
            user-select: none;
        }
        .bed.on {
            background-color: yellow;
            font-size: 24px;
            font-weight: bold;
        }
        #back {
            margin-top: 10px;
            padding: 10px 20px;
            font-size: 16px;
            /* ã€ä¿®æ”¹ã€‘æŒ‰éˆ•é¡è‰²å·²æ”¹ç‚ºç°è‰² */
            background-color: #6c757d; 
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #back:hover {
            background-color: #5a6268;
        }
        #update-time {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }
        #time-selector {
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <h1>1A IV Cap</h1>

    <div id="controls">
        <!-- ã€ä¿®æ”¹ã€‘æŒ‰éˆ•æ–‡å­—å·²æ›´æ–°ï¼Œä»¥åæ˜ æ–°åŠŸèƒ½ -->
        <button id="back">ğŸ”™ å›åˆ°ä¸Šä¸€æ­¥ (Undo)</button>
        <div id="time-selector">
            <label for="time-point">æŸ¥çœ‹æ­·å²ç‹€æ…‹: </label>
            <select id="time-point">
                <option>æ²’æœ‰æ­·å²ç´€éŒ„</option>
            </select>
        </div>
        <div id="update-time">ç•¶å‰æ™‚é–“: <span id="time"></span></div>
    </div>
  <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const beds = document.querySelectorAll('.bed');
        const backButton = document.getElementById('back');
        function displayState(snapshot) {
            if (!snapshot || !snapshot.state) return;
            const onBeds = snapshot.state;
            beds.forEach(bed => {
                if (onBeds.includes(bed.dataset.bed)) {
                    bed.classList.add('on');
                } else {
                    bed.classList.remove('on');
                }
            });
        }
        function handleBedClick(bedElement) {
            const isOn = bedElement.classList.contains('on');
            const clickCount = parseInt(bedElement.dataset.clickCount || '0', 10);
            let newClickCount = clickCount + 1;
            let stateChanged = false;
            if (newClickCount === 1 && !isOn) {
                stateChanged = true;
            } else if (newClickCount === 3 && isOn) {
                stateChanged = true;
                newClickCount = 0;
            } else if (newClickCount >= 3) {
                newClickCount = 0;
            }
            bedElement.dataset.clickCount = newClickCount;
            if (stateChanged) {
                const currentOnBeds = [];
                beds.forEach(b => {
                    if (b === bedElement) {
                        if (!isOn) currentOnBeds.push(b.dataset.bed);
                    } else {
                        if (b.classList.contains('on')) currentOnBeds.push(b.dataset.bed);
                    }
                });
                const newSnapshot = {
                    timestamp: new Date().getTime(),
                    state: currentOnBeds
                };
                socket.emit('bed-state-change', newSnapshot);
            }
        }
        socket.on('state-update', (snapshot) => {
            console.log('æ”¶åˆ°ä¼ºæœå™¨å»£æ’­çš„æœ€æ–°ç‹€æ…‹:', snapshot);
            displayState(snapshot);
        });
        beds.forEach(bed => {
            bed.addEventListener('click', () => {
                handleBedClick(bed);
            });
        });
        backButton.addEventListener('click', () => {
            socket.emit('undo-request');
        });
    </script>
</body>
</html>
    <!-- HTML çµæ§‹ä¿æŒä¸è®Š -->
    <!-- Team 1 -->
    <div class="team">
        <h2>Team 1</h2>
        <div id="bed-list">
            <div class="bed" data-bed="1">1</div><div class="bed" data-bed="2">2</div><div class="bed" data-bed="3">3</div><div class="bed" data-bed="4">4</div><div class="bed" data-bed="5">5</div><div class="bed" data-bed="6">6</div><div class="bed" data-bed="7">7</div><div class="bed" data-bed="8">8</div><div class="bed" data-bed="9">9</div><div class="bed" data-bed="10">10</div><div class="bed" data-bed="11">11</div><div class="bed" data-bed="12">12</div><div class="bed" data-bed="13">13</div><div class="bed" data-bed="14">14</div><div class="bed" data-bed="15">15</div>
        </div>
    </div>
    <!-- Team 2 -->
    <div class="team">
        <h2>Team 2</h2>
        <div id="bed-list">
            <div class="bed" data-bed="16">16</div><div class="bed" data-bed="17">17</div><div class="bed" data-bed="18">18</div><div class="bed" data-bed="19">19</div><div class="bed" data-bed="19A">19A</div><div class="bed" data-bed="20">20</div><div class="bed" data-bed="21">21</div><div class="bed" data-bed="22">22</div><div class="bed" data-bed="23">23</div><div class="bed" data-bed="24">24</div><div class="bed" data-bed="25">25</div><div class="bed" data-bed="26">26</div><div class="bed" data-bed="27">27</div><div class="bed" data-bed="28">28</div><div class="bed" data-bed="29">29</div>
        </div>
    </div>
    <!-- Team 3 -->
    <div class="team">
        <h2>Team 3</h2>
        <div id="bed-list">
            <div class="bed" data-bed="30">30</div><div class="bed" data-bed="31">31</div><div class="bed" data-bed="32">32</div><div class="bed" data-bed="33">33</div><div class="bed" data-bed="34">34</div><div class="bed" data-bed="34A">34A</div><div class="bed" data-bed="35">35</div><div class="bed" data-bed="36">36</div><div class="bed" data-bed="36A">36A</div><div class="bed" data-bed="37">37</div><div class="bed" data-bed="38">38</div><div class="bed" data-bed="39">39</div><div class="bed" data-bed="40">40</div><div class="bed" data-bed="41">41</div><div class="bed" data-bed="42">42</div><div class="bed" data-bed="43">43</div><div class="bed" data-bed="43A">43A</div><div class="bed" data-bed="44">44</div>
        </div>
    </div>

    <script>
        const beds = document.querySelectorAll('.bed');
        const timeDisplay = document.getElementById('time');
        const timePointSelect = document.getElementById('time-point');
        const backButton = document.getElementById('back');
        const storageKey = 'bedSystemHistory';

        function getHistory() {
            const historyJSON = localStorage.getItem(storageKey);
            return historyJSON ? JSON.parse(historyJSON) : [];
        }

        function saveState() {
            const history = getHistory();
            const onBeds = [];
            beds.forEach(bed => {
                if (bed.classList.contains('on')) {
                    onBeds.push(bed.dataset.bed);
                }
            });
            const newSnapshot = {
                timestamp: new Date().getTime(),
                state: onBeds
            };
            history.push(newSnapshot);
            localStorage.setItem(storageKey, JSON.stringify(history));
            updateTimePoints();
        }

        function displayState(snapshot) {
            if (!snapshot) {
                 beds.forEach(bed => bed.classList.remove('on'));
                 return;
            };
            const onBeds = snapshot.state;
            beds.forEach(bed => bed.classList.remove('on'));
            onBeds.forEach(bedId => {
                const bedToTurnOn = document.querySelector(`.bed[data-bed="${bedId}"]`);
                if (bedToTurnOn) {
                    bedToTurnOn.classList.add('on');
                }
            });
        }

        function loadLatestState() {
            const history = getHistory();
            if (history.length > 0) {
                const latestSnapshot = history[history.length - 1];
                displayState(latestSnapshot);
        }

        function updateTime() {
            const now = new Date();
            timeDisplay.textContent = now.toLocaleString();
        }

        function updateTimePoints() {
            const history = getHistory();
            timePointSelect.innerHTML = '';
            if (history.length === 0) {
                timePointSelect.innerHTML = '<option>æ²’æœ‰æ­·å²ç´€éŒ„</option>';
                return;
            }
            history.slice().reverse().forEach(snapshot => {
                const option = document.createElement('option');
                const recordTime = new Date(snapshot.timestamp);
                option.value = snapshot.timestamp;
                option.textContent = recordTime.toLocaleString();
                timePointSelect.appendChild(option);
            });
        }
        
        function initialize() {
            loadLatestState();
            updateTimePoints();
            setInterval(updateTime, 1000);

            beds.forEach(bed => {
                let clickCount = 0;
                if (bed.classList.contains('on')) {
                    clickCount = 1;
                }

                bed.addEventListener('click', () => {
                    clickCount++;
                    let stateChanged = false; // å»ºç«‹ä¸€å€‹æ——æ¨™ï¼Œåˆ¤æ–·ç‹€æ…‹æ˜¯å¦çœŸçš„æ”¹è®Š

                    if (clickCount === 1) {
                        bed.classList.add('on');
                        stateChanged = true; // ç‹€æ…‹æ”¹è®Šäº†
                    } else if (clickCount === 3) {
                        bed.classList.remove('on');
                        clickCount = 0;
                        stateChanged = true; // ç‹€æ…‹æ”¹è®Šäº†
                    }

                    // ã€å„ªåŒ–ã€‘åªæœ‰åœ¨ç‹€æ…‹çœŸçš„æ”¹è®Šæ™‚ï¼Œæ‰å„²å­˜æ­·å²ç´€éŒ„
                    if (stateChanged) {
                        saveState();
                    }
                });
            });

            timePointSelect.addEventListener('change', (event) => {
                const selectedTimestamp = Number(event.target.value);
                if (!selectedTimestamp) return;
                const history = getHistory();
                const foundSnapshot = history.find(s => s.timestamp === selectedTimestamp);
                if (foundSnapshot) {
                    displayState(foundSnapshot);
                }
            });

            // ã€åŠŸèƒ½ä¿®æ”¹ã€‘è¿”å›æŒ‰éˆ•çš„å…¨æ–° Undo é‚è¼¯
            backButton.addEventListener('click', () => {
                let history = getHistory();
                // å¿…é ˆæœ‰è¶…éä¸€ç­†ç´€éŒ„æ‰èƒ½è¿”å› (æ’¤éŠ·ç•¶å‰é€™ç­†ï¼Œå›åˆ°ä¸Šä¸€ç­†)
                if (history.length > 0) {
                    // 1. ç§»é™¤æœ€å¾Œä¸€ç­† (å³ç•¶å‰) çš„æ­·å²ç´€éŒ„
                    history.pop();
                    
                    // 2. å°‡è¢«ç¸®çŸ­äº†çš„æ­·å²ç´€éŒ„å­˜å› localStorage
                    localStorage.setItem(storageKey, JSON.stringify(history));
                    
                    // 3. è¼‰å…¥ä¸¦é¡¯ç¤ºæ–°çš„ã€Œæœ€å¾Œä¸€ç­†ã€ç´€éŒ„ (ä¹Ÿå°±æ˜¯è¿”å›å¾Œçš„ç‹€æ…‹)
                    loadLatestState();
                    
                    // 4. æ›´æ–°ä¸‹æ‹‰é¸å–®ï¼Œç§»é™¤å‰›å‰›è¢«åˆªé™¤çš„é¸é …
                    updateTimePoints();
                } else {
                    alert('å·²ç¶“æ˜¯ç¬¬ä¸€æ­¥ï¼Œç„¡æ³•å†è¿”å›ã€‚');
                }
            });
        }

        initialize();
    </script>
</body>
</html>